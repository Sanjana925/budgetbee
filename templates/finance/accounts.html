{% extends 'finance/base.html' %}
{% load static %}

{% block title %}Accounts - Budget Bee{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/accounts.css' %}">
{% endblock %}

{% block content %}

<h1>Accounts</h1>

<!-- Summary Cards -->
<div class="accounts-summary">
    <div class="summary-card">
        <div>Total Balance</div>
        <div>Rs {{ total_balance|floatformat:2 }}</div>
    </div>
    <div class="summary-card">
        <div>Total Income</div>
        <div>Rs {{ total_income|floatformat:2 }}</div>
    </div>
    <div class="summary-card">
        <div>Total Expenses</div>
        <div>Rs {{ total_expense|floatformat:2 }}</div>
    </div>
</div>

<!-- Scrollable Accounts List -->
<div class="accounts-cards-container">
    <div class="accounts-cards">
        {% for account in user_accounts %}
        <div class="account-card" data-id="{{ account.id }}">
            <div class="account-info" style="display: flex; align-items: center; gap: 12px;">
                <!-- Icon -->
                <div class="account-icon">{{ account.icon }}</div>

                <div>
                    <div class="account-name">{{ account.name }}</div>
                    <div class="account-balance">Balance Rs {{ account.balance|floatformat:2 }}</div>
                </div>
            </div>

            {% if request.user.is_authenticated %}
            <div class="account-actions">
                <button class="edit-btn"
                        data-id="{{ account.id }}"
                        data-name="{{ account.name }}"
                        data-balance="{{ account.balance }}"
                        data-icon="{{ account.icon }}">
                    Edit
                </button>

                <button class="delete-btn"
                        data-id="{{ account.id }}"
                        data-name="{{ account.name }}">
                    Delete
                </button>
            </div>
            {% endif %}
        </div>
        {% empty %}
        <p>No accounts found.</p>
        {% endfor %}
    </div>
</div>

<!-- Add Account Button -->
<div class="add-account-btn">
    {% if request.user.is_authenticated %}
        <button id="openAddAccount">+ Add Account</button>
    {% else %}
        <button type="button" data-requires-auth>+ Add Account</button>
    {% endif %}
</div>

{% if request.user.is_authenticated %}
<!-- Add / Edit Popup -->
<div class="popup-overlay hidden" id="popupOverlay">
    <div class="popup-card">
        <h3 id="popupTitle">Add New Account</h3>

        <form id="accountForm">
            {% csrf_token %}

            <label for="id_name">Account Name:</label>
            <input type="text" id="id_name" name="name" value="Untitled">

            <label for="id_initial_amount">Initial Amount:</label>
            <input type="number" id="id_initial_amount" name="initial_amount" value="0.0" step="0.01">

            <label>Pick an Icon:</label>
            <div class="icon-picker">
                {% for icon, label in default_account_icons %}
                <label class="icon-box">
                    <input type="radio" name="icon" value="{{ icon }}">
                    <span class="icon">{{ icon }}</span>
                </label>
                {% endfor %}
            </div>

            <div class="popup-actions">
                <button type="button" id="cancelPopup">Cancel</button>
                <button type="submit" id="savePopup">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Popup -->
<div class="popup-overlay hidden" id="deleteOverlay">
    <div class="popup-card">
        <h3>Delete Account</h3>
        <p id="deleteMessage"></p>

        <form id="deleteForm">
            {% csrf_token %}
            <div class="popup-actions">
                <button type="button" id="cancelDelete">Cancel</button>
                <button type="submit" id="confirmDelete">Delete</button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<!-- JS Data for accounts.js -->
<div id="accountsData"
     data-add-url="{% url 'finance:add_account' %}"
     data-edit-url="{% url 'finance:edit_account' 0 %}"
     data-delete-url="{% url 'finance:delete_account' 0 %}"
     data-is-authenticated="{{ request.user.is_authenticated|yesno:'true,false' }}">
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/accounts.js' %}"></script>
{% endblock %}
